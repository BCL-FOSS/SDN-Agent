{% extends 'app/app_base.html' %}

{% block content %}
<div class="card" id="chat3" style="border-radius: 15px;">
  <div class="card-body">
    <div class="row">
      <!-- Left side: MCP selection -->
      <div class="col-md-6 col-lg-5 col-xl-4 mb-4 mb-md-0">
        <div class="p-3">

          <!-- Search bar -->
          <div class="input-group rounded mb-3">
            <input type="search" class="form-control rounded" placeholder="Search" aria-label="Search"
              aria-describedby="search-addon" />
            <span class="input-group-text border-0" id="search-addon">
              <i class="fas fa-search"></i>
            </span>
          </div>

          <!-- Dropdown -->
          <div class="mb-3">
            <label for="mcp-dropdown" class="form-label">Select MCP Option:</label>
            <select id="mcp-dropdown" class="form-select"></select>
          </div>

          <!-- Dynamic List -->
          <div data-mdb-perfect-scrollbar-init style="position: relative; height: 400px" id="mcp-list-container">
            <ul class="list-unstyled mb-0" id="mcp-list">
              <!-- Populated via WebSocket -->
            </ul>
          </div>

        </div>
      </div>

      <!-- Right side: Chat window -->
      <div class="col-md-6 col-lg-7 col-xl-8">
        <div id="chat-window" style="height: 500px; overflow-y: auto;" class="border p-3 mb-3">
          <!-- Chat messages injected here -->
        </div>
        <div class="input-group">
          <input type="text" id="chat-input" class="form-control" placeholder="Type a message...">
          <button id="chat-send" class="btn btn-primary">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .new-item {
    animation: pulseHighlight 1s ease-in-out 2;
  }
  @keyframes pulseHighlight {
    0%   { background-color: #fff3cd; }
    50%  { background-color: transparent; }
    100% { background-color: #fff3cd; }
  }
  .chat-message { margin-bottom: 8px; }
  .chat-message.user { text-align: right; }
  .chat-message.agent { text-align: left; }
</style>

<script type="text/javascript">
document.addEventListener("DOMContentLoaded", () => {
  const mcpList = document.getElementById("mcp-list");
  const mcpDropdown = document.getElementById("mcp-dropdown");
  const listContainer = document.getElementById("mcp-list-container");
  const chatWindow = document.getElementById("chat-window");
  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");

  let currentOptions = [];
  let selectedValue = null;
  let currentUser = "{{ user }}"; // replace with real Jinja var

  const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
  const wsURLMon = "{{ ws_url }}"
  const wsMon = new WebSocket(`${wsURLMon}`);

  const error_display = document.getElementById("error_display");
  error_display.innerHTML="";

  try {

      ws.onopen = function () {
        console.log("Connected to WebSocket");
        ws.send(JSON.stringify({ act: "urls", "usr": `${currentUser}`}));
      };

      ws.addEventListener('message', function (event) {

        const data = JSON.parse(event.data);

        if (data.options) {
          updateOptions(data.options);
        }
        if (data.msg) {
          appendMessage(data.from, data.msg);
        }

      });

      ws.onerror = function (error) {
        console.error("WebSocket Error:", error);
      };

      ws.onclose = function () {
        console.log("WebSocket connection closed");
      };

  } catch (error) {
      error_display.innerHTML = "Error: " + error;
  }

  function updateOptions(options) {
    const oldOptions = [...currentOptions];
    currentOptions = options;

    if (!selectedValue || !currentOptions.includes(selectedValue)) {
      selectedValue = currentOptions[0] || null;
      if (selectedValue) {
        loadChat(selectedValue, currentUser);
      }
    }

    mcpDropdown.innerHTML = "";
    currentOptions.forEach(option => {
      const opt = document.createElement("option");
      opt.value = option;
      opt.textContent = option;
      mcpDropdown.appendChild(opt);
    });
    if (selectedValue) mcpDropdown.value = selectedValue;

    mcpList.innerHTML = "";
    currentOptions.forEach(option => {
      const li = document.createElement("li");
      li.classList.add("p-2", "border-bottom");
      li.dataset.value = option;
      li.innerHTML = `
        <a href="#!" class="d-flex justify-content-between">
          <div class="d-flex flex-row">
            <div>
              <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava1-bg.webp"
                alt="avatar" class="d-flex align-self-center me-3" width="60">
              <span class="badge bg-success badge-dot"></span>
            </div>
            <div class="pt-1">
              <p class="fw-bold mb-0">${option}</p>
              <p class="small text-muted">Description for ${option}</p>
            </div>
          </div>
          <div class="pt-1">
            <p class="small text-muted mb-1">Now</p>
          </div>
        </a>
      `;
      li.addEventListener("click", () => {
        selectedValue = option;
        mcpDropdown.value = option;
        loadChat(option, currentUser);
      });
      mcpList.appendChild(li);
    });
  }

  async function loadChat(url, user) {
    const res = await fetch("/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mcpurl: url, usr: user })
    });
    const messages = await res.json();
    chatWindow.innerHTML = "";
    messages.forEach(msg => appendMessage(msg.from, msg.msg));
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function appendMessage(from, text) {
    const div = document.createElement("div");
    div.classList.add("chat-message", from === "user" ? "user" : "agent");
    div.textContent = text;
    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  chatSend.addEventListener("click", async () => {
    if (!selectedValue || !chatInput.value.trim()) return;
    const msg = chatInput.value.trim();
    appendMessage("user", msg);
    chatInput.value = "";

    await fetch("/send_message", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ url: selectedValue, usr: currentUser, from: "user", msg: msg })
    });
  });

  mcpDropdown.addEventListener("change", () => {
    selectedValue = mcpDropdown.value;
    loadChat(selectedValue, currentUser);
  });
});
</script>
{% endblock %}
